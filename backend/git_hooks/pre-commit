#!/bin/bash

# Rodando PHP-CS-Fixer
output=$(docker compose exec app ./vendor/bin/pint)

# Rodando PHPStan e garantindo saída em formato JSON
phpstan_erro=$(docker compose exec app ./vendor/bin/phpstan analyse --configuration=./phpstan.neon --memory-limit=-1 --error-format=json)

# Exibindo a saída do PHPStan
echo "$phpstan_erro"

# Verificando erros do PHPStan
error_count=$(echo "$phpstan_erro" | jq '.files | to_entries | map(select(.value.errors > 0)) | length')

if [[ $error_count -gt 0 ]]; then
  echo "Erro(s) encontrado(s) pelo PHPStan. Corrija os erros antes de continuar."
  exit 1
fi

# Verificando se o arquivo phpstan.dist.neon existe
if [ -f "./phpstan.dist.neon" ]; then
  # Caso o arquivo phpstan.dist.neon exista, restaura a lista de arquivos ignorados
  sed -i 's/#.*-.*phpstan-baseline.neon/\t- .*phpstan-baseline.neon/' phpstan.dist.neon
else
  echo "Arquivo phpstan.dist.neon não encontrado. Ignorando restauração de lista de arquivos."
fi

exit 0
